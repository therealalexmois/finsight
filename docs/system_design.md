# RFC: Проектирование системы FinSight

## 1. Контекст

**FinSight** — это веб-приложение для отслеживания личных финансов и прогнозирования движения акций на основе технического анализа. Система интегрируется с публичным API Tinkoff Invest для получения данных о счёте пользователя, а также предоставляет простой машинно-обучающий сервис для прогноза краткосрочного движения акций (1–7 дней) по ISIN-коду.

---

## 2. Проблематика

Большинство частных инвесторов не имеют доступа к лёгким в использовании инструментам для анализа финансового состояния и прогнозирования движения активов. Приложение решает эту проблему путём объединения:
- Визуализации личных доходов и расходов.
- Простого API для анализа и предсказания рыночного поведения.
- Возможности расширения до полноценного инвестиционного помощника.

---

## 3. Терминология

| Термин       | Описание                                                                 |
|--------------|--------------------------------------------------------------------------|
| ISIN         | Международный идентификатор ценной бумаги.                              |
| Tinkoff API  | Публичный gRPC API для работы с инвестиционными данными.                |
| KNN          | Метод ближайших соседей — простой алгоритм машинного обучения.          |
| FastAPI      | Современный web-фреймворк Python для разработки API.                    |
| TA           | Technical Analysis — технический анализ, основанный на графиках и индикаторах. |
| MA/EMA       | Скользящие средние — один из базовых индикаторов тех. анализа.          |

---

## 4. Дополнительные материалы

- [Tinkoff API Docs](https://russianinvestments.github.io/investAPI/)
- [Python SDK](https://russianinvestments.github.io/investAPI/faq_python/)
- [TA-Lib (тех. индикаторы)](https://mrjbq7.github.io/ta-lib/)
- [Non-functional requirements (ByteByteGo)](https://blog.bytebytego.com/p/non-functional-requirements-the-backbone)

---

## 5. Сценарии использования

### 5.1 Сценарий 1 — Просмотр финансовой сводки

- **ID**: UC-01  
- **Актор**: Пользователь  
- **Название**: Просмотр финансов за выбранную дату  
- **Описание**: Пользователь запрашивает отображение баланса, доходов и расходов за указанную дату.
- **Схема**: _Будет добавлена через PlantUML_

---

### 5.2 Сценарий 2 — Прогноз цены по ISIN

- **ID**: UC-02  
- **Актор**: Пользователь  
- **Название**: Прогноз краткосрочного движения акций  
- **Описание**: Пользователь вводит ISIN, получает визуализированный прогноз с использованием KNN модели.
- **Схема**: _Будет добавлена через PlantUML_

---

### 5.3 Сценарий 3 — История транзакций

- **ID**: UC-03  
- **Актор**: Пользователь  
- **Название**: Просмотр доходов/расходов по дате  
- **Описание**: Отображение категорий доходов и расходов за выбранный период.
- **Схема**: _Будет добавлена через PlantUML_

---

## 6. Системные требования

### 6.1 Функциональные требования

| ID   | Приоритет  | Описание                                                                  |
|------|------------|---------------------------------------------------------------------------|
| FR-01 | must have | Интеграция с API Tinkoff Invest для получения данных о счёте             |
| FR-02 | must have | Отображение доходов и расходов по дате                                   |
| FR-03 | should have | Прогноз по ISIN с использованием ML-модели                             |
| FR-04 | should have | Визуализация данных (MA, EMA, свечи, и пр.)                            |

---

### 6.2 Нефункциональные требования

| ID   | Приоритет  | Описание                                                                  |
|------|------------|---------------------------------------------------------------------------|
| NFR-01 | must have | Ответ API не дольше 200ms при наличии кэшированных данных               |
| NFR-02 | must have | Хранение токенов доступа в зашифрованном виде                           |
| NFR-03 | should have | Расширяемая архитектура с поддержкой разных моделей ML                 |
| NFR-04 | should have | Отслеживание метрик и логов                                             |

---

## 7. Архитектура

### 7.1 C1 — Контекстная диаграмма

_Будет добавлена через PlantUML и LikeC4_

### 7.2 C2 — Диаграмма контейнеров

_Будет добавлена через PlantUML и LikeC4_

### 7.3 API стиль: REST

### 7.4 Аутентификация:
- OAuth2 + токен доступа Tinkoff Invest
- В будущем — JWT и RBAC

### 7.5 Модель БД (ERD)

_Проектирование с помощью dbdiagram.io или dbml_  
Сущности: `User`, `Transaction`, `Prediction`, `StockHistory`

---

## 8. Технологический стек

| Компонент         | Технология       |
|------------------|------------------|
| Язык             | Python 3.13      |
| Веб-фреймворк     | FastAPI          |
| МЛ-библиотека     | scikit-learn     |
| СУБД             | PostgreSQL       |
| Кэш              | Redis            |
| Очередь          | Celery (в будущем)|
| CI/CD            | GitHub Actions   |
| Контейнеризация  | Docker           |
| Reverse Proxy    | Nginx            |
| Мониторинг       | Prometheus + Grafana |
| Хранение логов   | ELK stack        |
| Документация     | Docusaurus + LikeC4 |

---

## 9. API-дизайн

| Endpoint                | Метод | Запрос                         | Ответ                                 | Статусы       |
|-------------------------|-------|--------------------------------|----------------------------------------|----------------|
| `/account/summary`      | GET   | `?date=YYYY-MM-DD`            | JSON: баланс, доходы, расходы          | 200, 401, 500  |
| `/transactions`         | GET   | `?from=...&to=...`            | JSON: список транзакций               | 200, 401, 500  |
| `/predict`              | GET   | `?isin=...`                   | JSON: результат прогноза + график     | 200, 400, 500  |

---

## 10. План реализации

| Этап | Название                  | Что входит                                | Часы |
|------|---------------------------|--------------------------------------------|------|
| 1    | Подготовка проекта        | FastAPI, структура, конфиги                 | 4    |
| 2    | Интеграция Tinkoff API    | Клиент, модели, авторизация                | 6    |
| 3    | Работа с транзакциями     | Сервис учета и отображения                 | 6    |
| 4    | ML-модель (KNN)           | Подбор признаков, baseline, API            | 8    |
| 5    | Визуализация              | matplotlib/plotly, интеграция в UI         | 5    |
| 6    | Тесты и CI                | pytest, GitHub Actions, интеграция         | 5    |

---

## 11. Риски

| ID  | Описание                                               | Митигирование                    |
|-----|--------------------------------------------------------|----------------------------------|
| R1  | Недостаточная точность ML-модели                       | Обоснованный выбор модели, baseline |
| R2  | API Tinkoff изменится или будет нестабилен             | Кэширование, fallback механизмы  |
| R3  | Сложность масштабирования при добавлении пользователей | Архитектурная модульность        |

---

## 12. Тестирование

### Сценарии тестирования:

| ID  | Тип          | Сценарий                                           |
|-----|--------------|----------------------------------------------------|
| TC1 | Позитивный   | Успешный прогноз по ISIN                          |
| TC2 | Негативный   | Некорректный ISIN — ошибка 400                   |
| TC3 | Разрушительный | Проблемы в API Tinkoff — возврат 500            |
| TC4 | Позитивный   | Получение транзакций за выбранный период         |

---

## 13. Блок “Имплементация модели”

Для первой версии будет использоваться модель `KNeighborsClassifier` из библиотеки `scikit-learn`. Она подходит для baseline-решения, проста в реализации и интерпретации, не требует длительного обучения. Признаки будут рассчитаны с использованием технических индикаторов (MA, EMA, MACD и др.). Целевой признак — изменение цены за один день (рост/падение). Ожидаемая точность модели — 60–70%.

---

## 14. Пайплайны CI/CD

- **Lint + Typing**: `ruff`, `mypy`, `pre-commit`
- **Тестирование**: `pytest`, покрытие > 80%
- **Сборка образа**: Docker build, push to registry
- **Деплой**: на VPS с Docker Compose/docker-swarm

---
